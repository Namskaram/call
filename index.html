<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simple Call</title>
</head>
<body>
  <h2>ğŸ“ Simple Call</h2>

  <!-- YOUR ID -->
  <label>
    Your ID:
    <input id="my-id-input" placeholder="Enter your ID">
  </label>
  <button id="set-id-btn">âœ” Apply ID</button>

  <p>Current ID: <span id="my-id">Not set</span></p>

  <hr>

  <!-- OTHER ID -->
  <label>
    Other person ID:
    <input id="other-id" placeholder="Enter other ID">
  </label>

  <br><br>

  <!-- ACTION BUTTONS -->
  <button id="call-btn" disabled>ğŸ“ Call</button>
  <button id="hang-btn" disabled>ğŸŸ¥ Hang Up</button>
  <button id="speaker-btn" disabled>ğŸ”Š Speaker: ON</button>

  <h3>Status: <span id="status">ID not set</span></h3>

  <audio id="remote-audio" autoplay></audio>

  <!-- PeerJS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.5/peerjs.min.js"></script>
  <script>
    let peer = null;
    let localStream = null;
    let currentCall = null;
    let speakerOn = true;

    const myIdSpan = document.getElementById("my-id");
    const statusSpan = document.getElementById("status");
    const myIdInput = document.getElementById("my-id-input");
    const setIdBtn = document.getElementById("set-id-btn");

    const otherIdInput = document.getElementById("other-id");
    const callBtn = document.getElementById("call-btn");
    const hangBtn = document.getElementById("hang-btn");
    const speakerBtn = document.getElementById("speaker-btn");
    const remoteAudio = document.getElementById("remote-audio");

    // Apply ID button
    setIdBtn.onclick = () => {
      const newId = myIdInput.value.trim();
      if (!newId) {
        alert("Enter your ID first!");
        return;
      }

      // Destroy old peer if exists
      if (peer) peer.destroy();

      peer = new Peer(newId); // <-- constant ID chosen by user
      myIdSpan.textContent = newId;
      statusSpan.textContent = "Connecting...";

      // When ready
      peer.on("open", () => {
        statusSpan.textContent = "Ready";
        callBtn.disabled = false;
      });

      // Incoming call
      peer.on("call", async (call) => {
        statusSpan.textContent = "Incoming callâ€¦ answering";
        currentCall = call;
        hangBtn.disabled = false;

        try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          call.answer(localStream);

          call.on("stream", (remoteStream) => {
            remoteAudio.srcObject = remoteStream;
            statusSpan.textContent = "In call";
            speakerBtn.disabled = false;
          });

          call.on("close", endCall);
        } catch {
          statusSpan.textContent = "Mic permission denied";
        }
      });

      // Error
      peer.on("error", (err) => {
        statusSpan.textContent = "Error: " + err.type;
      });
    };

    // Outgoing call
    callBtn.onclick = async () => {
      const otherId = otherIdInput.value.trim();
      if (!otherId) {
        alert("Enter other person ID!");
        return;
      }

      statusSpan.textContent = "Calling " + otherId + "â€¦";

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        const call = peer.call(otherId, localStream);
        currentCall = call;
        hangBtn.disabled = false;

        call.on("stream", (remoteStream) => {
          remoteAudio.srcObject = remoteStream;
          statusSpan.textContent = "In call";
          speakerBtn.disabled = false;
        });

        call.on("close", endCall);
      } catch {
        statusSpan.textContent = "Mic error";
      }
    };

    // Hang up
    hangBtn.onclick = () => {
      if (currentCall) currentCall.close();
      endCall();
    };

    function endCall() {
      statusSpan.textContent = "Call ended";
      hangBtn.disabled = true;
      speakerBtn.disabled = true;
      remoteAudio.srcObject = null;

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      currentCall = null;
    }

    // Speaker toggle
    speakerBtn.onclick = () => {
      speakerOn = !speakerOn;
      remoteAudio.muted = !speakerOn;
      speakerBtn.textContent = speakerOn ? "ğŸ”Š Speaker: ON" : "ğŸ”‡ Speaker: OFF";
    };
  </script>
</body>
</html>
