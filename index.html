<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Family Call</title>
</head>
<body>
<h2>ğŸ“ Family Call</h2>

<label>
  Who are you?
  <select id="role">
    <option value="son">I am Charlie (Son)</option>
    <option value="dad">I am Dad</option>
  </select>
</label>

<p>Your ID: <span id="my-id"></span></p>
<p>Other ID: <span id="other-id"></span></p>

<button id="call-btn">ğŸ“ Call</button>
<button id="hang-btn" disabled>ğŸŸ¥ Hang Up</button>
<button id="speaker-btn" disabled>ğŸ”Š Speaker ON</button>

<h3>Status: <span id="status">Not connected</span></h3>

<audio id="remote-audio" autoplay></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.5/peerjs.min.js"></script>
<script>
const SON_ID = "987654";
const DAD_ID = "123456";

const role = document.getElementById("role");
const myIdSpan = document.getElementById("my-id");
const otherIdSpan = document.getElementById("other-id");
const callBtn = document.getElementById("call-btn");
const hangBtn = document.getElementById("hang-btn");
const speakerBtn = document.getElementById("speaker-btn");
const statusSpan = document.getElementById("status");
const remoteAudio = document.getElementById("remote-audio");

let peer, localStream, currentCall, speakerOn = true;

// Setup IDs when role changes
function updateIDs() {
  if (role.value === "son") {
    myIdSpan.textContent = SON_ID;
    otherIdSpan.textContent = DAD_ID;
  } else {
    myIdSpan.textContent = DAD_ID;
    otherIdSpan.textContent = SON_ID;
  }
}

// Create Peer when role changes
function createPeer() {
  if (peer) peer.destroy();
  peer = new Peer(myIdSpan.textContent);

  peer.on("open", () => {
    statusSpan.textContent = "Ready";
  });

  // Incoming call
  peer.on("call", async (call) => {
    statusSpan.textContent = "Incoming call... answering";
    currentCall = call;
    hangBtn.disabled = false;

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      call.answer(localStream);

      call.on("stream", (remoteStream) => {
        remoteAudio.srcObject = remoteStream;
        statusSpan.textContent = "In call";
        speakerBtn.disabled = false;
      });

      call.on("close", endCall);
    } catch {
      statusSpan.textContent = "Mic permission denied";
    }
  });

  peer.on("error", err => {
    statusSpan.textContent = "Error: " + err.type;
  });
}

// Call button
callBtn.onclick = async () => {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    statusSpan.textContent = "Calling...";

    const call = peer.call(otherIdSpan.textContent, localStream);
    currentCall = call;
    hangBtn.disabled = false;

    call.on("stream", (remoteStream) => {
      remoteAudio.srcObject = remoteStream;
      statusSpan.textContent = "In call";
      speakerBtn.disabled = false;
    });

    call.on("close", endCall);
  } catch {
    statusSpan.textContent = "Mic permission denied";
  }
};

// Hang up
hangBtn.onclick = () => {
  if (currentCall) currentCall.close();
  endCall();
};

// End call cleanup
function endCall() {
  statusSpan.textContent = "Call ended";
  hangBtn.disabled = true;
  speakerBtn.disabled = true;
  remoteAudio.srcObject = null;

  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
  currentCall = null;
}

// Speaker
speakerBtn.onclick = () => {
  speakerOn = !speakerOn;
  remoteAudio.muted = !speakerOn;
  speakerBtn.textContent = speakerOn ? "ğŸ”Š Speaker ON" : "ğŸ”‡ Speaker OFF";
};

// Initialize
role.onchange = () => {
  updateIDs();
  createPeer();
};

updateIDs();
createPeer();
</script>
</body>
</html>
