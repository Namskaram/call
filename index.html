<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simple Call</title>
</head>
<body>
  <h2>ðŸ“ž Simple Call Demo</h2>

  <p>Your ID (fixed): <span id="my-id"></span></p>

  <label>
    Other person ID:
    <input id="other-id" placeholder="Enter other ID">
  </label>
  <br><br>

  <button id="call-btn">ðŸ“ž Call</button>
  <button id="hang-btn" disabled>ðŸŸ¥ Hang Up</button>
  <button id="speaker-btn" disabled>ðŸ”Š Speaker: ON</button>

  <h3>Status: <span id="status">Startingâ€¦</span></h3>

  <audio id="remote-audio" autoplay></audio>

  <!-- PeerJS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.5/peerjs.min.js"></script>
  <script>
    // ðŸ”´ CHANGE THIS FOR EACH DEVICE ðŸ”´
    // Example:
    //  - On your phone:  const MY_ID = "person-001"
    //  - On dad's phone: const MY_ID = "person-002"
    const MY_ID = "person-001"; // <-- set this per device

    const myIdSpan    = document.getElementById('my-id');
    const otherIdInput = document.getElementById('other-id');
    const statusSpan  = document.getElementById('status');
    const callBtn     = document.getElementById('call-btn');
    const hangBtn     = document.getElementById('hang-btn');
    const speakerBtn  = document.getElementById('speaker-btn');
    const remoteAudio = document.getElementById('remote-audio');

    let localStream = null;
    let currentCall = null;
    let speakerOn   = true;

    // Show fixed ID
    myIdSpan.textContent = MY_ID;

    // Create peer with CONSTANT ID
    const peer = new Peer(MY_ID);

    peer.on('open', (id) => {
      console.log('My ID:', id);
      statusSpan.textContent = 'Ready';
    });

    // Incoming call
    peer.on('call', async (call) => {
      statusSpan.textContent = 'Incoming callâ€¦ answering';
      currentCall = call;
      hangBtn.disabled = false;

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        call.answer(localStream);

        call.on('stream', (remoteStream) => {
          remoteAudio.srcObject = remoteStream;
          statusSpan.textContent = 'In call';
          speakerBtn.disabled = false;
        });

        call.on('close', endCall);
      } catch (err) {
        console.error(err);
        statusSpan.textContent = 'Mic permission denied';
      }
    });

    // Outgoing call
    callBtn.onclick = async () => {
      const otherId = otherIdInput.value.trim();
      if (!otherId) {
        alert('Enter other person ID!');
        return;
      }

      statusSpan.textContent = 'Calling ' + otherId + 'â€¦';

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        const call = peer.call(otherId, localStream);
        currentCall = call;
        hangBtn.disabled = false;

        call.on('stream', (remoteStream) => {
          remoteAudio.srcObject = remoteStream;
          statusSpan.textContent = 'In call';
          speakerBtn.disabled = false;
        });

        call.on('close', endCall);
      } catch (err) {
        console.error(err);
        statusSpan.textContent = 'Mic permission denied / error';
      }
    };

    // Hang up
    hangBtn.onclick = () => {
      if (currentCall) currentCall.close();
      endCall();
    };

    function endCall() {
      statusSpan.textContent = 'Call ended';
      hangBtn.disabled = true;
      speakerBtn.disabled = true;
      remoteAudio.srcObject = null;

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      currentCall = null;
    }

    // Speaker toggle (mute/unmute remote sound)
    speakerBtn.onclick = () => {
      speakerOn = !speakerOn;
      remoteAudio.muted = !speakerOn;
      speakerBtn.textContent = speakerOn ? 'ðŸ”Š Speaker: ON' : 'ðŸ”‡ Speaker: OFF';
    };

    peer.on('error', (err) => {
      console.error(err);
      statusSpan.textContent = 'Error: ' + err.type;
    });
  </script>
</body>
</html>
